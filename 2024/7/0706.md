# Gasip 댓글 수정/삭제 모달이 여러 개 렌더링 되는 문제를 해결하는 과정.

테스트를 하던 중 가장 먼저 발견한 문제는 한 번에 여러 댓글 삭제/수정 액션모달이 표시되는 문제였다.

이에 대해서 더 살펴보던 중, 특정 모달이 열려있을 때 백그라운드를 터치하면 닫히도록 설정해둔 백그라운드가 전체 화면을 덮지 않는 이슈가 있다는 것을 알게 되었다.

이 문제를 해결하려면 결국 background의 backdrop이 렌더링 되고, 그 위에 수정/삭제 모달이 표시되도록 처리해야 한다.

## 문제 해결 과정

문제 해결 과정에서 알게 된 것이 몇 가지 있다.

**React Native에서 zIndex는 부모의 zIndex를 초과할 수 없다.**

무슨 소리인고 하면, 부모컴포넌트의 형제 컴포넌트가 zIndex가 부모보다 더 높은 상태에서, 부모 컴포넌트의 자식 컴포넌트에 아무리 zIndex값을 높게 줘도 부모 컴포넌트보다 더 위에 렌더링 될 수가 없다. 약간...카스트제도 같은 신분제 느낌이랄까...

**onLayout 함수는 부모를 기준으로 위치가 결정된다**

전체 화면 기준으로 계산되는 것이 아니라, 부모를 기준으로 위치가 결정된다.

이걸 처음에 알아봤던 이유는, 수정/삭제 모달과 그에 따른 backdrop이 자식 컴포넌트(개별 댓글 컴포넌트)에서 렌더링 하는 경우 이 컴포넌트가 부모 컴포넌트 그 위로 렌더링이 되지 않았기 때문이다.

이에 따른 나의 사고흐름은

- 렌더링이 정확히 어떤 순서/기준으로 overlap되어있는지 파악한다.
- 그리고 필요하다면 배경과 모달을 가장 바깥 부모 컴포넌트에 구현하고, 이를 버튼을 눌러서 render하는 형식으로 변경한다.
- 배경은 크게 어렵지 않은데, 개별 모달의 위치를 해당 컴포넌트 밖에서 위치를 구해서 해당 위치에 렌더링하는게 약간 까다로울 수 있음.

## 그런데 애초에 이 개별적 모달이 맞는 UXUI일까?

먼저 코드단에서 문제를 해결하기 전에, 애초에 현재 디자인에 잡혀있는 모달 방식과 다른 방식으로 풀어낼 수 잇지 않을까 하는 생각이 들었다.

다른 앱들은 비슷한 상황에서 UX를 어떻게 풀어냈는지 궁금해서 찾아보았다.

내가 참고한 앱들은, 트위터, 레딧, 당근마켓 등의 앱들이었다.

해당 앱들은 모두 바텀업 모달로 이 UX를 풀어내고 있었고, 나도 이 형태가 조금 더 일관성이 있고 일반적으라고 느껴져서 이런 부분을 정리해서 디자이너 팀원에게 의견을 전달하였다.

그런데 내가 몰랐던 부분이 있는데, 트위터의 경우 같은 버튼을 눌렀을 때 안드와 iOS의 상호작용이 달랐다.

iOS에서는 디자이너분이 잡아주신 UI와 비슷하게 처리되는 부분이 있었다. 이를 근거로 일단 개별적 모달로 가는걸로 최종 결정하였다.

(사실 다른 앱들도 같이 보여주셨으면 좋겠긴한데, 또 이게 얼굴을 맞대고 서로 본적이 없는 상태에서 공격적으로 받아들여질까 싶은 걱정이 있어 더 물어보지 못한 점은 아쉽다.)

iOS폰을 하나 구해야하나 싶은 생각이 들기도 한다.

## 해결 방법 결정하기

개별 모달의 위치를 각각 계산하는 방식은 여러 변수가 존재해서 모달이 이상한 위치에 렌더링 될 가능성이 있다고 판단하였다.

그래서 모달이 열렸을때 배경을 전체적으로 덮을 수 있는 방법을 고민해본 결과, 배경을 전체적으로 덮을 수 있는 처리를 하는 것으로 결정하였다.

이를 위해서는 다음의 것들이 필요하다고 판단하였음.

아래에서 레이어라고 함은, 여러 뎁스로 구성된 컴포넌트 트리의 각 단계를 말한다.

여러 레이어에 걸쳐서 배경을 구현했어야 하는 이유가 뭐냐면, 모달이 속해있는 컴포넌트가 가장 아래쪽에 위치한 컴포넌트이기 때문에, 해당 모달이 가장 위에 표시되어야 하는 컴포넌트인데 문제는 자식 컴포넌트의 zIndex값이 부모 컴포넌트의 zIndex값 이상으로 설정될 수가 없음.

그렇다고 해서 자식 컴포넌트에서 자신의 배경을 다 가린다고 해도, 부모 컴포넌트 밖에 있는 영역은 가려지지가 않는다.

즉 2가지 문제점으로 쪼갤 수 있는 것.

- 배경을 다 가려야하는데, 자식 컴포넌트에서만 배경을 가리면 가려지지 않는 영역이 존재한다.
- 그런데 그렇다고 부모 컴포넌트에서 배경을 다 가리기 위해서 자식 컴포넌트 이상의 zIndex를 부여해서 가리는 컴포넌트를 만들어서 렌더링하면, 자식 컴포넌트에 위치한 모달이 같이 가려진다. 부모 컴포넌트보다 zIndex값이 높을 수가 없기 때문에...

그래서 이를 해결하기 위해서는 각 레이어별로 모달이 표시되었을 때 각 단계에 맞는 zIndex값을 설정해서 배경을 다 가리는 형태로 구현되어야 한다고 결론을 내렸다.

즉 여러 겹으로 배경이 겹쳐서 쌓인 형태이고, 이 중 어떤 레이어를 눌러도 호출되는 로직은 동일하게 맞추는 형태이다.

이를 위해서 아래 사항들이 필요하다고 판단하였음.

- 여러 컴포넌트에서 SSOT로 참조할 수 있는 특정 모달이 열려있음을 알 수 있는 변수
  - zustand store를 하나 만들었다. 별도의 기능 단위로 묶는게 좋다고 생각했음.
- 각 레이어별로 해당 변수를 참조해서 배경을 덮을 컴포넌트
  - 각 레이어별로 위치를 계산해서, 최대한 많은 범위를 커버할 수 있는 범위에 컴포넌트를 같은 변수를 참조해서 추가
- 각 레이어별로 해당 컴포넌트가 렌더링되고, 눌렸을 때 같은 동작(모달 닫힘)을 수행하도록 처리
  - 모달을 닫는 로직을 구현하기 위해서도 문제가 있었는데, 모달을 닫고 여는 변수는 각 댓글 컴포넌트에서 관리하고 있는 상태였기 때문에 이 상태를 처리하는 함수를 여러 backdrop에서 공유하기 위한 방법이 필요했다. 그래서 모달을 여는 시점에, 해당 모달을 닫는 함수를 store에 등록해서 여러 컴포넌트에서 참조하는 형태로 구현하였음.

이런 과정을 통해서 모달이 열려있을 때 배경을 누르면 모달이 닫히도록 설정할 수 있었다.
