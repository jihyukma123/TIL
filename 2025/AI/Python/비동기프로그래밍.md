# 파이썬에서의 비동기 프로그래밍

# 비동기 프로그래밍을 왜 하려고 하는건지?

`시간이 오래 걸리는 작업`을 효율적으로 처리하려고.

non-blocking -> 네트워크 통신이나 파일 입출력에 발생하는 대기 시간 낭비하지 않고 CPU가 다른 처리를 할 수 있게 하는 것.

파이썬은 기본적으로 동기 방식으로 동작하는 언어이긴 하지만, 3.4에 asyncio 모듈이 표준 라이브러리로 추가되고 3.5에 async/await 문법이 추가되면서 비동기 프로그래밍 구현이 가능해짐.

# 핵심 문법

`def` 키워드로 선언한 함수는 기본적으로 동기적으로 동작.

비동기 함수는 `async def` 키워드로 선언하는데, 이 함수는 동기함수 호출하는 것처럼 호출할 수 없음.(호출하면 함수 결과값이 아니라 coroutine 객체 메모리 주소가 찍힌다.)

`await`키워드를 붙여서 호출해야된다.

# (추가 공부) Why use async programming??

애초에 비동기 프로그래밍이라는 컨셉이 등장하게 된 이유 같은 것들이 궁금해서 좀 찾아봤음.

## Synchronous 하다는 것의 의미.

동기적이라는 것은 요청을 했을 때(네트워크, 디스크 read 등등) 프로세스에는 적어도 하나의 스레드가 있는데 이 스레드가 실제 작업을 함.

여기서 작업의 종류가 2가지가 있을 수 있는데,

- 하나는 실제로 스레드가 어떤 연산을 처리하는 경우 ex. 어떤 숫자 연산을 처리할 때라던지...
- 스레드가 어떤 외부 자원을 요청하는 경우 ex. 디스크에 저장된 값 불러올 때.

후자의 경우에는 스레드가 실제로 뭔가를 처리하고 있지는 않지만, blocked and waiting 상태가 된다.

이게 동기 프로그래밍임. 요청 보내고, 별다른 처리를 하지 않으면서도 blocked and waiting 상태가 되는 것.

다른 코드 실행을 할 수가 없음.

아니 비효율적이네!!! 이거 뭐 어떻게 해결할 방법이 없나..?

-> 스레드를 늘리면 안되나??

근데 스레드 늘릴려고 하니까 동기화 문제 같은 복잡한 문제를 신경써야 해서 쉽지 않음.

`Thread-safe`하게 멀티스레딩을 통해서 동시에 여러 작업을 처리하는게 굉장히 까다로운 작업이었던 것...

그러면 어떡해?? 비동기 프로그래밍으로 이 문제를 한 번 해결해보자.

## 비동기 프로그래밍

nodejs가 아주 잘 구현된 예시임.

`Single Threaded, non-blocking async framework`.

비동기적이라는게 뭔가??

싱글스레드 상에서 비동기적으로 동일하게 디스크에서 값을 가져오는 걸 처리하려면..?

요청을 보내고, 기다려야 한다는 것은 똑같지. 기다리는 것은 피할 수가 없음.

근데 그냥 요청보내고 기다리는게 아니라, 요청을 보낼 때 요청에 대한 처리가 요청을 처리하는 쪽에서 완료되면 호출하는 콜백함수를 같이 전달함.

'작업 완료되면 콜백함수 실행해서 나한테 알려줘~~' 하는거지. 그리고 나서 스레드는 blocked 되어있는 상태가 아니라 다시 다음 작업을 계속 이어서 실행함.

요청을 보낸 입장에서는 요청이 완료되어서 실행된 콜백함수로 인해서 도착한 어떤 신호(작업이 완료되었다는 신호와 그 결과물)을 인지해서 처리할 메커니즘이 필요하잖아. JavaScript에서 이걸 처리하기 위해서 구현한 메커니즘이 Event Loop.

근데 문제가 좀 있는데, 코드가 좀 더러워짐.(콜백 중첩 지옥에 빠지게 되는 경우가 많았음..)

JavaScript는 이걸 promise라는 개념으로 해결하고자 시도했음. then-catch. -> async await

## 다 필요없고 그냥 프로세스 여러개로 처리해!

멀티 프로세싱.

각각 별도의 자원을 가지는 여러 개의 프로세스들을 사용해서 inter-process 소통 같은 방법들을 사용해서 작업을 처리한다.

멀티프로세싱의 장점은, 여러 머신에 나눠서 작업을 처리하는게 가능하다는 것.

## 아하 그렇구낭

스레드 하나로 작업 처리할 때, 요청 보내고 기다리는 동기프로그래밍은 비효율이 발생함(연산은 하지 않으면서 대기하는 상황, blocked and executing이 아니라 blocked and waiting이 발생)

그래서 이 문제 해결하려고, 멀티스레드 구조로 하면 어떨까했더니 병렬적으로 작업 처리는 되는데 여러 스레드가 동시에 동일한 자원에 접근가능한 구조 때문에 발생하는 동기화 문제 같은 것들을 잘 처리해서 `thread-safe`한 프로그램 만드는게 너무 어려움.

그래서 하나의 스레드 안에서 싱글스레드 구조 안에서도 스레드가 작업없이 대기하는 비효율을 없애고자 비동기 프로그래밍이 등장함. 하나의 스레드에서 동시 처리를 하기 위한 프로그래밍 방법.

동기적으로 실행하는게 아니라, 요청 순서가 꼭 응답 순서와 일치하지 않을 수 있는 구조를 만든 것.

nodejs의 경우 이벤트루프를 통해서 이를 구현함.

**참고자료**

[Asynchronous vs Multithreading and Multiprocessing Programming (The Main Difference)](https://www.youtube.com/watch?v=0vFgKr5bjWI)
