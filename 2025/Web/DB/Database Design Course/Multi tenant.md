# Multi Tenant??

자산관리 서비스 만들면서 테이블 설계하면서 문득 이런 생각이 들었다.

이 데이터는 유저별로 분리해서 관리가 되어야 하는데, 그러면 DB가 어떻게 관리되어야 하는거지??

- 하나의 DB 테이블에 여러 유저의 데이터를 저장하고, user_id 같은 필드를 통해서 식별한다.?
- Shared Table이랑, User 별로 각각 가져야 하는 테이블을 구분하고 유저별 데이터는 유저별로 각각 테이블을 준다(?)

어떻게 하는게 맞는지 이게 정확히 어떤 문제인지 잘 몰라서 찾아봄 그랬더니 ChatGPT가 Multi tenant 머시기 하길래 유튭 영상 하나 봤다.

# Multi Tenancy?

그 전에 일단 Multi tenant application/architecture에 대해서 먼저 알아봤음.

[The Ultimate Guide to Multi-Tenancy in 5 minutes](https://www.youtube.com/watch?v=ZYuu8sWUQww)

멀티 테넌트 구조에서는, 앱의 단일 인스턴스가 여러 tenant(or customer)에게 서비스를 제공하는 구조

각 tenant는 각자 격리된 데이터와 설정값을 가지지만, 하드웨어/소프트웨어 리소스를 공유함.

하드웨어 위에 VM(가상머신)을 실행시키는 방법은 하드웨어를 여러 앱 인스턴스가 격리된 구조로 공유할 수 있게 해주는 중요한 기술

또한 Cloud computing의 등장으로 하드웨어/소프트웨어 리소스 공유하는 구조가 더욱 고도화되었음.

하나의 Web Server는 여러 tenant(가 사용하는 웹사이트)를 hosting 할 수 있다고 한다.

이런 구조에서는 Data isolation이 중요함.

> 음 사실 이해가 잘 되지 않는 부분들이 있어서 날잡고 더 파봐야할듯?

# 영상 정리

자 이제 GPT가 추천해준 영상 보고 공부를 좀 해보자.

[Multi-Tenant: Database Per Tenant or Shared?](https://www.youtube.com/watch?v=YaSPB2uNLYg)

multi tenant application이라는 건 내 생각에는 여러 사용자가 동시에 접속해서 동일한 서비스를 사용하게 되는 앱을 말하는 것 같음.

이런 서비스는 Shared DB를 쓸지 아니면 DB per tenant를 쓸지 고민이 필요함.

참고로 어떤 구조를 선택할지는 항상 그렇지만 뭘 만드는지, 어떤 문제를 중요하게 생각하는지에 따라 다르고 정답이 없음.

## Shared Database

서로 다른 사용자가 동일한 API와 동일한 DB인스턴스를 통해서 서비스를 제공받는 구조..

단일 DB인스턴스를 여러 사용자가 공유하기 때문에 저장하고자 하는 데이터와 함께 어떤 사용자의 데이터인지 인지할 수 있는 데이터가 같이 저장되어야 한다.(참고로 설명을 보니까 꼭 tenant와 customer가 1:1관계는 아닐 수 있는 것 같음. tenant하나가 여러 customer를 가질수도 있는 구조)

참고로 RDB를 사용하면서 shared db로 가는 경우에는 모든 테이블에 tenant 정보를 포함시키는 것을 추천함(그러면 단일 테이블 조회 시 tenant 정보를 얻기 위한 조인을 수행할 필요가 없음)

장점

- 심플함: 관리가 편함. 변경점이 있으면 단일 인스턴스만 업데이트하면 됨

단점

- 데이터 유출 가능성: 특정 사용자의 데이터가 다른 사용자에게 노출될 가능성이 존재함.
  - 이 문제를 방지하기 위해서 추천하는 한 가지 방법은, tenant 정보를 통해서 쿼리를 필터하는 로직을 포함시키는 것. (tenant id 가 일치하는 정보만 반환되도록. 참고로 이 로직을 모든 쿼리에 적용되도록 코드를 짰다는데 이 부분 잘 이해가 안되긴 한다 다시 들어봐야지)
- `noisy neighbor`문제: 여러 tenant가 동일한 리소스를 공유하다보니 한 사용자가 요청을 많이 보내거나 하는 경우 아무 잘못이 없는 다른 사용자에게 제공되는 서비스의 퍼포먼스가 떨어지거나 하는 문제가 발생할 수 있음.
  - 사용자별 사용할 수 있는 connection의 수를 제한하는 방법으로 완화할 수도 있고(정확히 무슨 소린지 모르겠음.)
  - 또 하나의 방법은 `rate limiting`. 사용자별로 사용량 제한을 관리하는 방법으로 load balancer나 미들웨어 등 방법으로 구현하면 됨.

그리고 이 구조에서는 모든 요청에 대해서 요청자가 누구인지 식별하기 위한 메커니즘이 필요함. bearer token 같은...

## DB Per tenant

Tenant를 식별해서 해당되는 DB로 연결되는 것.

DB는 해당 고객만 사용하는 것이기 때문에,

- 따로 쿼리 필터 같은거 할 필요 없고,
- 공유하는 정보가 없기 때문에 정보 유출 걱정없음.

장점

- noisy neighbor 문제 없음
- (DB연결만 잘 하면) 정보 유출 위험 감소

단점

- 복잡함: 관리해야될 DB가 많음. 코드베이스에서 스키마 변경이 있으면 모든 tenant DB를 다 업데이트 해야한다.
  - 해결방법은 tenant 마다 별도 api 레이어를 제공해서 코드 변경이 특정 tenant에만 영향을 주도록 하는 것.

근데 그러면 사실상 멀티테넌트가 아닌데..?(싱글 테넌트 구조처럼 됨)

-> 하이브리드 방식도 가능하다는 소리임

## 하이브리드 방식

tenant A,B가 동일한 리소스 공유하고, tenant C가 별도 리소르를 할당받는 구조.

이러면 자원을 공유하면서도 필요한 리소스만 업데이트 한다던지 하는 식의 유연성을 가져갈 수 있음.

하지만?? 반대급부로 복잡성 급증함..ㅠㅠ

참고로 이런 hybrid 구조에서는 하나의 DB에서 다른 DB로 유저 정보를 옮길수도 있기 때문에, 그런 경우에 대비해서 고유 식별자를 globally unique하게 만드는 것을 추천함.(옮겨도 중첩되는 문제 없도록)

## 결정을 위해서 질문해야되는 문제점들.

- what are the number of tenants you are having
- 그 숫자가 퍼포먼스에 영향을 줄 것인가?(noisy neighbor 문제를 고려해야 하는가?)
- 다수의 DB를 사용하는 비용 대비 효율이 나오는지?
- 저장해야되는 데이터의 양이 어떻게 되는지?
- (개발 유지보수 관점에서)배포 시 고려해야되는 사항들이 어떻게 되는지 또는 유지보수에 투입할 수 있는 리소스는?
