# 섹션3 개념적 모델링

## 요구사항 분석과 핵심 요소 선별

왜 요구사항 분석부터 해야되는지? -> DB는 결국 비즈니스의 거울임.

개념적 모델링은 개발자, 기획자, 디자이너 등이 모여서 '우리가 구현하고자 하는 세상은 이런 모습이다'라는 것을 합의하는 과정임.

개발할 때 가장 중요한 관점은, `그래서 우리가 할 일이 뭔데?`이다. 개발자니까 기술에 매몰되는 경향이 있는데 뭐가됐든 어떤 가치를 만들어내는지, 그를 위해서 무엇을 하는지가 중요함.

엔티티와 관계를 찾아내는 과정이라고 볼 수 있음.

엔티티를 찾는 쉬운 방법은 먼저 명사에서 찾는거임. 근데 무조건 '명사'에 꽂혀서 문법적인 의미에서의 명사를 찾으라는게 아니라, `시스템이 정보를 저장하고 관리해야될 대상`을 찾으라는거임.

- 요구사항 목록에서 명사를 뽑아낸다
- 각 명사별로 엔티티로 관리가 필요한지 판단한다(엔티티로 뽑아서 관리해야될지, 아니면 특정 엔티티의 속성으로 관리되어야 할지 등등을 처리하는 것.)
- 다음으로 중요한 동사를 뽑는다.(주문이라는 동사를 생각해보자.) 동사가 관리해야될 기록이나 증빙을 남기는가?(주문은 주문서라는 중요한 기록을 남김)
- 동사의 명사형으로 새로운 엔티티를 만든다.(주문하다는 동사지만, 기록을 생성하니까 주문이라는 명사형으로 엔티티가 필요함)

그 다음에 엔티티 간의 관계를 파악해야함.

- 회원은 자산을 추가한다.
  - '회원'과 '추가'간의 관계가 있음.(누가 기록했는지?)
  - '회원'과 '자산'간의 관계가 있음.(어떤 자산을 기록했는지?)

## 엔티티란?

엔티티의 중요한 특성을 기억하는게 좋아 보임.

- 업무에 관련되어야 한다.(제일 중요)
  - 그치 내가 하려는 비즈니스에 관련된 데이터여야겠지.
- 식별가능해야 함.
  - 서로 다른 row를 유일하게 식별할 수 있는 메커니즘이 필요.
- 2개 이상의 정보를 가진다.
  - 단일 정보(컬럼)으로 구성된 엔티티는 속성일 가능성이 있으니 다시 생각해보도록.
- 인스턴스 집합이다.
  - row하나하나를 인스턴스라고 함(엔티티 자체는 거푸집이라고 생각하면 됨)
  - 2개 이상의 인스턴스로 구성된 집합이어야 한다고 함.
- 다른 엔티티와 관계를 맺는다.
  - 이 관계를 파악하는 것이 DB설계의 핵심이다. 대부분의 엔티티는 다 관계가 있다고 함.

### 엔티티인가 속성인가..?

처음에 많이 헷갈린다고 함.

`우리 서비스에서 독립적으로 관리되어야 하는 정보인가`라는 질문을 기반으로 생각해보자.

그리고 너무 과도하게 설계하지말라고 추천함.(일단 가시권 내에 확실히 구현할거라고 생각되는 기능들 위주로 보고 필요하면 해결하는걸로.)

## 엔티티 분류

데이터를 뽑아냈으면, 이제 데이터의 성격에 대해서 생각해봐야한다.

데이터는 다 똑같은 데이터가 아님. 이게 무슨소리여? 데이터가 어떻게 사용되고 축적되는지에 따라서 생각해봐야하는 부분이 다를 수 있다.

예를 들어, `회원`과 `지출`이라는 엔티티 2개 생각해보자.

회원은 한 번 생기면 잘 변하지 않고 유지되는 데이터인반면,

지출은 새롭게 발생하는 사건임. 시간이 지나면서 회원보다 지출이 훨씬 더 데이터의 양이 많아질 것이 명백함.

침실을 설계하는거랑, 주방을 설계하는게 다른것이랑 비슷한 원리라고 이해함.

이런 생각까지 같이 해두면 더 효율적인 DB설계가 가능하다.

존재형태에 따라 분류해보기 -> 유형/개념/사건

여기서 특히 사건 엔티티는 비즈니스 활동의 결과를 기록하는거라 조금 다르고, 통계 및 분석의 핵심 소스가 됨.

보통 사건 엔티티는 발생량이 많다.

이렇게 엔티티를 분류해봤을 때, 엔티티가 어떤 유형으로 구성되어 있는지를 확인하면 어떤 시스템을 만들려는지 엿볼 수도 있음.(대충 보면 공장인지 아파트인지 알 수 있는 것처럼)

데이터의 성격/증가 추이를 미리 분석하면 차후 발생할 문제들에 어떻게 대응할지 전략을 세우는 것도 가능함.

### 역할 및 발생시점에 따른 분류: 기본, 중심, 행위 엔티티

논리적인 흐름을 보기 위해서 해보는 거임.

회원이 있어야 자산이 있다 같은거지.

---

가장 중요한 부분은 용어가 아님.

용어보다는, 각 데이터의 특성을 파악하고, 비슷한 데이터들이 가졌던 패턴을 인식해서 데이터를 관리하는데 고려되어야 하는 사항들을 인식하는 훈련을 하는 것.

### 강한 엔티티 약한 엔티티

자산같은게 강한 엔티티, 자산종류(유동/비유동/주식/부동산 등)는 약한 엔티티
-> 약한 엔티티는 보통 식별하기 위해서 소유 엔티티의 주식별자 빌려와서 식별자 구성에 같이 사용함

근데 이거 왜 구분해? 굳이 구분해서 사고해야되는 이유가 뭘까??

약한 엔티티라고 판단되는 정보는 애초에 독립적으로 존재할 가능성 자체를 없애는게 필요함(자산 종류만 남아있고 자산이 없으면 이상하잖아)

테이블 키/외래키 제약조건 설계 시 꼭 고려해야되는 사항임.

식별관계/비식별관계라는 개념이 있는데 식별 관계가 교과서적인 방법이지만, 요즘 실무에서는 비식별관계를 많이 사용한다고 함.

### 연관 엔티티

수강 같은 엔티티

2개 이상 엔티티 사이에 발생하는 사건 계약 등을 표현(학생이 과목을 수강하는걸 표시)

### 실습

자산관리 프로젝트에서 요구사항을 기반으로 엔티티를 찾는 연습을 해보자.

1. 엔티티를 찾는다.

- 명사를 파악한다
- 명사가 비즈니스 활동에 직접적인 연관이 있는지 분석한다
- 동사 중에서 기록이 필요한 증빙이나 결과가 생성되는지 파악
- 필요하다면 해당 동사도 엔티티로 분리(명사화)

2. 엔티티로 뽑는게 맞는지 검증한다.

엔티티가 아니라 속성으로 뽑을만한 항목은 아닌지?

3. 엔티티 간 관계를 파악한다.

회원과 자산간의 관계 같은...

4. 엔티티를 분류해보면서 데이터의 특성을 파악한다.

- 유저 1인당 한 번 생성되는 데이터인가? 아니면 자주 생성되고 여러 row가 많이 누적될 가능성이 큰 데이터인가?
- 그 자체로 존재하는 엔티티인가? 아니면 다른 엔티티의 자식 엔티티 성격을 가지는가? 아니면 2 엔티티 간의 관계를 기록하기 위해서 필요한 엔티티인가?
- 엔티티 생성 흐름이 어떻게 되는가? 엔티티A가 생성되기 위해서 다른 엔티티의 존재가 전제되는가?

## 속성과 식별자

식별자 - 데이터의 유일한 이름표, 데이터를 다른 데이터와 구분할 수 있는 값, primary key

엔티티 정의 -> 엔티티 구성하는 속성 정의 -> 엔티티를 대표하는 식별자 정의 flow로 지금 가고 있는거임.

## 카디널리티와 참여도

엔티티를 만들고, 엔티티끼리 뭔가 관계가 있는것 까지는 분석을 완료했음.

(엔티티 만들고 엔티티끼리 선을 연결하긴 한 상태)

근데 이게 무슨 관계인지 아직 정확하게 모름. 1:1이야? 1:N이야? 이런 관계 규칙을 상세하게 설정할 필요가 있다.

관계의 규칙을 정의하는데 2가지 핵심요소가 `카디널리티`와 `참여도`

카디널리티 - 한 엔티티 인스턴스가 다른 엔티티 인스턴스와 몇 개나 관계를 맺을 수 있는지? 1:1, 1:N, N:1, M:N 이런거 말하는거임.

카디널리티는 헷갈린다 싶으면 그냥 인스턴스 하나 입장에서 파악해봐라.

회원1(회원 테이블 인스턴스 하나) 입장에서 보면

- 회원은 여러 개의 주문을 가질 수 있나? YES
- 주문1은 여러 회원에 연결될 수 있나? NO 한 명의 회원하고만 연결되어야 함
  -> 이 둘을 조합하면 회원과 주문은 1:N의 관계가 된다는 것을 알 수 있음.

관계라는건 2명이 필요하잖아? 1:N이라는건 회원 입장이고, 주문입장에서는 N:1이라는 점.

다대다 관계도 존재함 상품과 주문은 서로 다대다임. 하나의 상품이 여러 주문에 포함될 수 있고, 하나의 주문에 여러 상품이 포함될 수 있고.

영한님 강조사항

`닥치고 인스턴스 하나별로 나눠서 생각해보면 된다.`

`참여도`는 관계에 필수여부를 의미함. 관계에 반드시 참여해야되는지? 아니면 참여하지 않아도 되는지?

회원입장에서 주문이 필수임? NO. 주문을 안한 회원도 존재가능
주문입장에서 회원이 필수임? YES. 주문한 사람이 없는데 주문이 있으면 유령주문이지 이상해!

이렇게 카디널리티와 참여도를 정확하게 정의하면 이게 곧 비즈니스 규칙을 정하는 것이고, 이를 데이터 모델에 녹여내는 것임.

## 관계의 표현과 외래 키

개념적 모델링 단계에서는 엔티티 간 관계를 관계선으로만 표시하고, 외래 키 같은 특정 기술의 구현적 요소(외래 키는 RDBMS 요소인데, 개념적
모델링은 RDB는 NoSQL이건 상관없이 적용가능하게 만드는게 목표임)는 포함하지 않는 것이 원칙

하지만 말그대로 원칙이고, 실무에서는 개념/논리 모델링을 같이 진행하는 경우가 많아서 처음부터 포함시키는 경우도 많음.

## ERD 완성하기

지금까지 분석한 내용으로 그림으로 표현하면 ERD임.

ERD가 모든 관계자가 시스템 청사진을 한 눈에 파악할 수 있게 해주는 설계에서 가장 강력한 도구임.

참고로 많은 경우에 그림으로 설명하는게 많은 사람들이 이해하는데 도움이 된다고 함.

생각을 안해봤는데 그림을 잘 활용해보면 소통에 큰 도움이 되겠다 싶음. 꿀팁이네!!! 말보다는 직관적으로 이해되는 그림 같은게 도움이 된다.

`피터 첸 표기법`이 있고 `까마귀발 표기법`이 있음

피터첸은 실무에서는 잘 사용 안함(복잡하고 공간을 너무 많이 차지함)

까마귀발 표기법이 사실상 표준이라고 봐야함(de facto standard - 시장에서 널리 사용되어서 사실상 표준이라고 볼 수 있는 것)
참고로 대부분의 도구(MySQL Workbench, DBeaver 등 도구들이) 까마귀발 표기법을 기본으로 지원한다고 함.

## 연관 엔티티 - 다대다 관계 해결

주문과 상품의 관계는 다대다임.

하나의 주문에는 여러 상품이 포함될 수 있고,
하나의 상품은 여러 주문에 포함될 수 있다.

근데 이걸로 DB테이블 만들려고 하면 2가지 문제에 직면함.

1. M:N 관계는 물리적으로 구현할 수 없다.

이론적으로는 주문 1개에 여러 상품을 연결해야함.

근데 주문 테이블에 하나의 주문id에 대해서 하나의 상품id가 연결되는 구조 -> 2개의 상품을 하나의 주문에 연결할 수가 없음.

어? 근데 그냥 한 컬럼에 데이터 여러 개 넣을 수 있게 해서 저장하면 되는거 아님??이라고 생각을 했는데, 바로 `절대 피해야할 방식`이라고 하면서 나왔음 ㅋㅋㅋㅋ 이래서 배워야된다!!!! 첫 프로젝트에서도 생각해보라고 했던건데...이렇게 했을 때 어떤 문제점이 있을까? 그 문제점은 어떻게 보완할 수 있을까? 같은 부분들을 생각해보는게 좋지 않을까.

무튼 이 방법은 왜 안되는데?? `상품ids` 같은 컬럼 만들어서 여러 개 저장하면 되지 않음?

-> 이거는 **`관계형 데이터베이스의 근간을 흔드는 최악의 설계`**라고 함.

이유는?

- 데이터 검색이 힘들어짐. '102'라는 상품번호를 포함하고 있는 row를 검색하려고 하면 잘못하면 1102가 포함된것도 검색될수도 있고 그렇다.
- 데이터 수정 및 삭제의 복잡성(예를 들어서 여러 상품 id중 하나만 삭제해야 한다면?)
- 원자성 위반: 데이터베이스의 제1 정규형, 즉 '테이블의 모든 칸은 원자적인(더 이상 쪼갤 수 없는) 값 하나만 가져야 한다'라는 원칙을 위배함.

2. 관계에 속한 데이터를 저장할 장소가 없다.

M:N 관계가 만들어지는 그 '순간'에만 의미를 갖는 데이터들을 저장할 장소가 없다.

이게 무슨소리인고 하면,

예를 들어서 고객 1001이 상품 102를 주문했을 때 가격이 1000원이라고 해보자.

그래서 1000원이라고 저장했는데 주문 테이블에,

문제는 나중에 그 상품의 가격이 1200원으로 업데이트 되면? 그러면 이거를 주문 테이블에 반영할거야 말거야? 상품에 1대1로 매칭되는 가격이라는 데이터의 일관성을 보면 반영을 해야하는데, 주문과 상품이 만나는 시점의 스냅샷인 주문데이터에는 그 시점에 얼마에 샀는지가 기록되어야 하는데 그러면 1000원으로 기록해야돼 1200원으로 기록해야돼?

그리고 주문이 여러 상품으로 구성되어 있으면 상품A가 몇 개고 상품B가 몇개인지 알 수가 없음.

주문가격은? 무슨 가격을 넣어?

그러면 이거를 주문 테이블이 아니라 상품 테이블에 저장해?? 상품 테이블은 현재 상품 정보를 관리하는 곳이라서 스냅샷을 저장하는것은 의미적으로 맞지 않음.

아니 그러면 뭐 어쩌라고!!!!!

-> `관계를 엔티티로 승격시키자.`

M:N 관계를 `연관 엔티티`로 바꾸는 것임.

`주문 항목`이라는 연관 엔티티를 만들면,

M:N 을 2개의 1:N 구조로 바꿔서 문제를 해결하는거임

주문은 여러 주문 항목을 가질 수 있고, 상품도 여러 주문 항목에 포함될 수 있는거임.

참고로 여러 이름으로 불리지만 중요한건 다대다 관계에서 생기는 문제를 해결하고 관계에 대한 데이터 저장하기 위해서 2개 이상의 테이블을 연결하는 중간 테이블을 의미함.

**실무 팁**

M:N 관계는 반드시 풀고, 필요한 속성을 찾아라.

개념적 모델링에서 M:N 관계를 발견했다면 2가지는 거의 100%라고 함

1. 어차피 연관 엔티티(연결 테이블)로 처리해야됨.
2. M:N 관계는 그 자체로 새로운 속성들이 필요하게 됨. 주문수량, 주문 시점의 가격, 주문 시점에 적용된 할인률 같은 데이터들...

그러니까 M:N 관계를 발견하면, 이 관계가 만들어지는 순간에만 의미를 가지는 데이터는 무엇일까?를 질문해서 필요한 데이터를 뽑아내라.

## 용어 사전

왜 필요해??

너 생각보다 용어 관련해서 불필요한 소통 리소스가 소모되는 경우가 많다.

회원이라는 개념에 대해서 member, customer, user 등등 변수를 사용하게 되면 나중에 감당이 안됨.

용어 사전을 미리 만들어서 이런 혼선을 최대한 방지하는게 필요하다.

개발 생산성과 시스템의 안정성을 극대화하는 매우 중요한 활동.

그리고 용어 사전은 지속적으로 관리하는게 포인트임. 모두가 편집할 수 있게 해야한당.

그리고 영한씨는 꼭 만들라고 함.(개발자들한테는 변수명 시간 짓는 시간 줄여주고, 전ㄹ체적인 일관성 확보와 소통 리소스 감소에 좋은 영향을 줌.)
