# 실행 컨텍스트

# 코어 자바스크립트

## 실행 컨텍스트란?

공교롭게 오늘 회사에서는 MCP를 공부하다가 왔는데 이것도 context네.

의미도 비슷함.

실행 컨텍스트는 실행할 코드에 제공할 환경 정보를 모아놓은 객체.

코드가 실행되는데 있어서 필요한 값들에 대한 정보 같은걸 저장해둔 객체라고 생각하면 될 듯?

호이스팅, 외부 환경 구성, this 등 다 이거랑 상관이 있는거임.

참고로 Closure 개념이 존재하는 언어는 다 비슷하거나 동일한 메커니즘이 적용되어 있다고 함 -> 한 번 깊게 잘 이해해두면 여러모로 도움이 된다.

## 실행 컨텍스트 구성하는 방법

자바스크립트가 실행되는 방식은,

`동일한 환경`에 있는 코드들을 실행하기 위해 필요한 `환경 정보`를 모아서 실행 컨텍스트를 구성하고, 이를 call stack에 쌓아서, Stack의 가장 위에 있는 환경에 있는 코드부터 실행하는 식으로 전체 코드의 실행 순서와, 실행되는 순서에 맞춰서 적절한 환경에서 실행됨을 보장하는 구조임.

`동일한 환경`이라고 언급한, 단일 실행 컨텍스트를 생성하는 방법은

- 전역공간(자동으로 생성됨)
- eval(뭔지 전혀 모르겠음 이름만 들어봄)
- 함수를 실행하는 것
- es6에서는 {}도 실행 컨텍스트를 생성한다고 함.

```javascript
// ----- (1) 전역공간의 실행 컨텍스트

var a = 1;

function outer() {
  function inner() {
    console.log(a); // 나는 이게 undefined가 아니라 1일줄 알았는데....뭘 모르는거지.. 후후 갈길이 멀구나.
    var a = 3;
  }
  inner(); // ------ (2) inner함수 호출로 실행 컨텍스트
  console.log(a);
}

outer(); // ----- (3) outer 함수 실행  컨텍스트

console.log(a);

// Call Stack을 보면...

[]
-> [전역 컨텍스트]
-> [전역 컨텍스트, outer]
-> [전역 컨텍스트, outer, inner]
-> [전역 컨텍스트, outer]
-> [전역 컨텍스트]
-> []
```

실행 컨텍스트가 활성화될 때 -> 엔진이 코드 실행에 필요한 정보를 수집해서 실행 컨텍스트 객체에 저장함(미리 들고 있는게 아니었나보네? 꼭 필요한 값만 가지고 있다가 실행되는 시점에 populate하는 식으로 동작하는건가??) 무튼 중요한 부분은 `코드 실행에 필요한 정보를 수집`인 것 같음.

실행 컨텍스트라는 것은 결국 코드 실행에 필요하다고 판단되는 정보를 저장하기 위한 구조가 가장 중요한 역할.

코드 실행을 위해서 수집되어 저장되는 정보들은 다음과 같음.

- VariableEnvironment
  - 생성 시점에는 LexicalEnvironment와 동일한 내용을 담고 있지만, 실행 시점의 Snapshot이라서 계속 동일한 데이터를 보관함
- LexicalEnvironment
  - '현재 코드 실행에 필요한 정보로는 a,b,c같은 식별자와, 외부 정보는 D가 있다' 같은 느낌으로 정보를 저장하는 곳이라고 생각하면됨.
  - environmentRecord + outerEnvironmentReference로 구성됨
- ThisBinding
  - this 식별자가 바라봐야하는 대상 객체(이게 바로 그 악명높은 this구나. 댐벼라)

### LexicalEnvironment

1. environmentRecord와 호이스팅.

호이스팅 안녕?? ㅎㅎ

현재 컨텍스트와 관련된 코드의 식별자 정보들이 저장.

실제로 코드가 실행되기 전에, 컨텍스트 안에 존재하는 모든 식별자 정보를 수집(함수 파라미터, const/let/var 변수,function 등등)

엔진 입장에서는 코드를 본격적으로 실행하기 전에 이미 실행하려는 코드 범위 내에 있는 모든 식별자에 대한 정보를 가지고 있음.

마치 실행되는 코드 최상단에 일단 변수를 쫙 써놓고, 밑에서 사용하는 것처럼 되는거임(실제로 코드 상에 위치와 무관하게)

그래서 함수/변수를 실제로 코드 상에서 선언하기 전에 코드 상에서 참조해도 undefined라고 접근이 됨(이 때 undefined는 공간은 초기화되었는데 값 할당 전이라는 의미의 undefined)

다만 let/const는 (아마 내 추측은 사람이 코드를 읽는 순서와 동일하게 맞춰서 안정성을 높이기 위해서) TDZ라는 개념을 도입해서, 동일하게 호이스팅은 되어서 정보는 수집되지만 공간 초기화는 실제로 변수 선언시점에 이루어지는 형태로 동작함. 그래서 렉시컬 환경에 변수 정보는 존재하지만, 초기화되기 전까지의 코드 상에서는 TDZ에 있어서 접근하려고 하면 초기화 전에 변수에 접근할 수 없다는 에러가 발생함.
(근데 아예 선언되지 않은 변수에 접근하면 어떻게 되나 궁금해서 해봤더니, 이 경우에는 'variable is not defined'라는 에러가 발생함. TDZ에 있음을 의미하는 'Cannot access 'befd' before
initialization'하고는 다르다.)
